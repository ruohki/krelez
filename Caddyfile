{
    # Global options
    admin off
}

:80 {
    # Handle chiptune paths
    handle_path /chip/* {
        reverse_proxy iceprxy-chiptune:3000
    }

    # Handle vapor funk paths
    handle_path /vapor/* {
        reverse_proxy iceprxy-vapor:3010
    }

    # Direct stream proxying
    handle_path /streams/chip {
        reverse_proxy http://79.120.11.40:8000 {
            header_up Host {upstream_hostport}
            header_up X-Forwarded-Host {host}
        }
        rewrite * /chiptune.ogg
    }

    handle_path /streams/vapor {
        reverse_proxy http://79.120.11.40:8000 {
            header_up Host {upstream_hostport}
            header_up X-Forwarded-Host {host}
        }
        rewrite * /vapor.ogg
    }

    # All other traffic goes to the main application
    handle {
        reverse_proxy chipend:4321
    }

    # Enable compression
    encode gzip
}
